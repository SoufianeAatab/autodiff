
    #include <stdlib.h>
    #include <stdio.h>
    #include <time.h>
    #include "conv2d_cmsis.cc"
    bool check(float* a, float* b, int size){
        for(int i=0;i<size;++i){
            if (fabs(a[i] - b[i]) > 0.00001) return false;
        }
        return true;
    }

    void print(float* a, int size){
        for(int i=0;i<size;++i){
            printf("%f, ", a[i]);
        }
        printf("\n");
    }
    
    int main(){
    //===================================================
float lr = 0.01;
float* buf = (float*)calloc(358, sizeof(float));
//buf[0] = input;
//buf[4] = output;
float temp_0[4] = {0.4926411, 0.82183236, 0.56179255, 0.24909973, };
memcpy(&buf[0], temp_0, sizeof(float) * 4 );
float temp_2[68] = {0.89935094, 0.040271163, 0.77720743, 0.17209798, 0.082109034, 0.23565996, 0.6358937, 0.66299313, 0.8805534, 0.28172648, 0.65946656, 0.86786014, 0.88140416, 0.41213763, 0.9146552, 0.5858208, 0.0013639331, 0.09046394, 0.45709765, 0.29246807, 0.939596, 0.8611049, 0.95123106, 0.018080175, 0.5878315, 0.25106788, 0.5096176, 0.7779757, 0.47882164, 0.08247489, 0.38707542, 0.5021153, 0.3327558, 0.2558614, 0.9474516, 0.08236116, 0.62782836, 0.109250486, 0.82552904, 0.0774219, 0.4159456, 0.5437524, 0.37744278, 0.14981091, 0.58662677, 0.1494484, 0.9877542, 0.2804132, 0.76140964, 0.46698707, 0.1554228, 0.47931325, 0.7103639, 0.91030747, 0.90743643, 0.86965317, 0.118454814, 0.6586757, 0.32999653, 0.307635, 0.26406032, 0.3489017, 0.32827652, 0.3470903, 0.7427703, 0.60306937, 0.17648166, 0.46840483, };
memcpy(&buf[37], temp_2, sizeof(float) * 68 );
float temp_1[16] = {0.097776115, 0.27886027, 0.7509991, 0.54492414, 0.57155716, 0.5212182, 0.45788455, 0.07759428, 0.367364, 0.10033637, 0.7068461, 0.048643887, 0.55169404, 0.009095967, 0.3417639, 0.72522163, };
memcpy(&buf[21], temp_1, sizeof(float) * 16 );
mat_mul(&buf[0] /* (1, 4) */, &buf[21] /* (4, 4) */, &buf[105] /* (1, 4) */, 1, 4, 4, 1, 4, 4, 1, 4); // (1, 4) 5
sigmoid(&buf[105] /* (1, 4)*/ , &buf[109] /*(1, 4)*/, 4); // (1, 4) 6
mat_mul(&buf[109] /* (1, 4) */, &buf[37] /* (4, 17) */, &buf[113] /* (1, 17) */, 1, 4, 4, 1, 4, 17, 1, 4); // (1, 17) 8
log_softmax(&buf[113], &buf[130], 17); // (1, 17) 9
exp_(&buf[130], &buf[147], 17); // (1, 17) 15
float temp_3[17] = {0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, };
memcpy(&buf[4], temp_3, sizeof(float) * 17 );
nll_loss(&buf[130], &buf[4], &buf[164], 17); // (1, 17) 10
for(uint32_t k=0;k<17;++k){
	buf[181 + k] = 1.0f;}
for(uint32_t k=0;k<17;++k){
	buf[198 + k] = -1;
}
mul(&buf[181], &buf[198], &buf[215], 17); // (1, 17) 13
mul(&buf[215], &buf[4], &buf[232], 17); // (1, 17) 14
add(&buf[147], &buf[232], &buf[249], 17); // (1, 17) 16
mat_mul(&buf[249] /* (1, 17) */, &buf[37] /* (17, 4) */, &buf[266] /* (1, 4) */, 1, 17, 17, 1, 17, 4, 4, 1); // (1, 4) 20
sigmoid_diff(&buf[105], &buf[266], &buf[270], 4); // (1, 4) 21
mat_mul(&buf[270] /* (4, 1) */, &buf[0] /* (1, 4) */, &buf[274] /* (4, 4) */, 4, 1, 1, 4, 1, 4, 4, 1); // (4, 4) 24
mat_mul(&buf[249] /* (17, 1) */, &buf[109] /* (1, 4) */, &buf[290] /* (17, 4) */, 17, 1, 1, 17, 1, 4, 4, 1); // (17, 4) 19
// sgd for 24
for (uint32_t k=0;k<16;++k){
	buf[21 + k] -= buf[274 + k] * lr;
}
// sgd for 19
for (uint32_t k=0;k<68;++k){
	buf[37 + k] -= buf[290 + k] * lr;
}
float test_1[4] = {0.8349910974502563, 0.9864913821220398, 0.6726562976837158, 0.651915431022644, };float test_1_grads[4] = {0.13523732125759125, 0.07153511047363281, 0.04945889487862587, 0.04041603207588196, };
    printf("============================\nTEST::test_1\n");
    if(check(&buf[105], test_1, 4)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[105], 4);printf("TRUE:\n");print(test_1, 4); }
    printf("============================\nTEST::test_1_grads\n");
    if(check(&buf[270], test_1_grads, 4)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[270], 4);printf("TRUE:\n");print(test_1_grads, 4); }float test_2[4] = {0.6974092721939087, 0.7283943295478821, 0.662097692489624, 0.6574419140815735, };float test_2_grads[4] = {0.6408452987670898, 0.36158788204193115, 0.22107069194316864, 0.1794576793909073, };
    printf("============================\nTEST::test_2\n");
    if(check(&buf[109], test_2, 4)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[109], 4);printf("TRUE:\n");print(test_2, 4); }
    printf("============================\nTEST::test_2_grads\n");
    if(check(&buf[266], test_2_grads, 4)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[266], 4);printf("TRUE:\n");print(test_2_grads, 4); }float test_3[17] = {1.2842806577682495, 1.085820198059082, 1.8265129327774048, 1.9056323766708374, 0.5617687106132507, 1.924201488494873, 1.4417259693145752, 0.9804022908210754, 1.0998882055282593, 1.1149119138717651, 1.0345463752746582, 1.3563214540481567, 1.289190649986267, 2.3310351371765137, 0.9831292629241943, 0.883838951587677, 1.3820843696594238, };float test_3_grads[17] = {0.05105382949113846, 0.04186374694108963, 0.08780450373888016, 0.09503376483917236, -0.9752117991447449, 0.09681496024131775, 0.05975935608148575, 0.037675198167562485, 0.042456842958927155, 0.04309951886534691, 0.03977133333683014, 0.05486750975251198, 0.05130511894822121, 0.14542129635810852, 0.03777807950973511, 0.034207284450531006, 0.05629942938685417, };
    printf("============================\nTEST::test_3\n");
    if(check(&buf[113], test_3, 17)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[113], 17);printf("TRUE:\n");print(test_3, 17); }
    printf("============================\nTEST::test_3_grads\n");
    if(check(&buf[249], test_3_grads, 17)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[249], 17);printf("TRUE:\n");print(test_3_grads, 17); }float test_4[17] = {-2.97487473487854, -3.173335075378418, -2.4326424598693848, -2.353523015975952, -3.6973867416381836, -2.334953784942627, -2.817429542541504, -3.2787532806396484, -3.1592671871185303, -3.1442434787750244, -3.224608898162842, -2.902833938598633, -2.9699647426605225, -1.9281202554702759, -3.2760262489318848, -3.375316619873047, -2.877070903778076, };float test_4_grads[17] = {0.0, 0.0, 0.0, 0.0, -1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, };
    printf("============================\nTEST::test_4\n");
    if(check(&buf[130], test_4, 17)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[130], 17);printf("TRUE:\n");print(test_4, 17); }
    printf("============================\nTEST::test_4_grads\n");
    if(check(&buf[232], test_4_grads, 17)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[232], 17);printf("TRUE:\n");print(test_4_grads, 17); }    
        return 0;
    }
    
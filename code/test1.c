
    #include <stdlib.h>
    #include <stdio.h>
    #include <time.h>
    #include "conv2d_cmsis.cc"
    bool check(float* a, float* b, int size){
        for(int i=0;i<size;++i){
            if (fabs(a[i] - b[i]) > 0.00001) return false;
        }
        return true;
    }

    void print(float* a, int size){
        for(int i=0;i<size;++i){
            printf("%f, ", a[i]);
        }
        printf("\n");
    }
    
    int main(){
    //===================================================
float lr = 0.01;
float* buf = (float*)calloc(262, sizeof(float));
//buf[0] = input;
//buf[4] = output;
float temp_1[16] = {0.4179238, 0.50451356, 0.23276854, 0.23893166, 0.7377794, 0.71832556, 0.13058627, 0.6284557, 0.41065216, 0.69673467, 0.41377616, 0.12620693, 0.98947245, 0.9791589, 0.988416, 0.1401909, };
memcpy(&buf[5], temp_1, sizeof(float) * 16 );
float temp_0[4] = {0.064364016, 0.7920679, 0.87280715, 0.2607537, };
memcpy(&buf[0], temp_0, sizeof(float) * 4 );
mat_mul(&buf[0] /* (1, 4) */, &buf[5] /* (4, 4) */, &buf[89] /* (1, 4) */, 1, 4, 4, 1, 4, 4, 1, 4); // (1, 4) 5
sigmoid(&buf[89] /* (1, 4)*/ , &buf[93] /*(1, 4)*/, 4); // (1, 4) 6
float temp_3[1] = {15, };
memcpy(&buf[4], temp_3, sizeof(float) * 1 );
for(uint32_t k=0;k<1;++k){
	buf[97 + k] = -1;
}
float temp_2[68] = {0.66657144, 0.23569554, 0.7905264, 0.5987201, 0.3846482, 0.04256469, 0.7641445, 0.5146812, 0.3109337, 0.061530888, 0.91384846, 0.38514775, 0.6806212, 0.98401046, 0.3276701, 0.43495983, 0.4347502, 0.72456163, 0.12151325, 0.49660552, 0.8027647, 0.49422044, 0.053377986, 0.547735, 0.36689562, 0.49643284, 0.6401977, 0.23687238, 0.9738642, 0.2551927, 0.5134887, 0.8697284, 0.31788856, 0.023025393, 0.77629703, 0.9975191, 0.838742, 0.13399535, 0.55470926, 0.81989825, 0.7614904, 0.5511324, 0.5244423, 0.76361555, 0.78253454, 0.29647893, 0.9516565, 0.3593307, 0.4388705, 0.86039925, 0.14251757, 0.7059542, 0.7683739, 0.676787, 0.9103846, 0.20529938, 0.84540474, 0.07747859, 0.4647954, 0.31007344, 0.4498405, 0.75033486, 0.50174975, 0.8297549, 0.66979975, 0.9005871, 0.20786351, 0.59069407, };
memcpy(&buf[21], temp_2, sizeof(float) * 68 );
mat_mul(&buf[93] /* (1, 4) */, &buf[21] /* (4, 17) */, &buf[98] /* (1, 17) */, 1, 4, 4, 1, 4, 17, 1, 4); // (1, 17) 8
log_softmax(&buf[98], &buf[115], 17); // (1, 17) 9
buf[132] = nll_loss(&buf[115], &buf[4], 17); // (1, 1) 10
for(uint32_t k=0;k<1;++k){
	buf[133 + k] = 1.0f;}
mul(&buf[133], &buf[97], &buf[134], 1); // (1, 1) 13
mul(&buf[134], &buf[115+(int)buf[4]], &buf[135], 1); // (1, 1) 14
exp_(&buf[115], &buf[136], 17); // (1, 17) 15
printf("TEST=%f * %f\n", buf[136 + (int)buf[4]], buf[135]);
add_b_n_1(&buf[136], &buf[135], &buf[153], 17); // (1, 17) 16
                                              print(&buf[115], 17);
                                              print(&buf[135], 17);
mat_mul(&buf[153] /* (17, 1) */, &buf[93] /* (1, 4) */, &buf[170] /* (17, 4) */, 17, 1, 1, 17, 1, 4, 4, 1); // (17, 4) 19
mat_mul(&buf[153] /* (1, 17) */, &buf[21] /* (17, 4) */, &buf[238] /* (1, 4) */, 1, 17, 17, 1, 17, 4, 4, 1); // (1, 4) 20
sigmoid_diff(&buf[89], &buf[238], &buf[242], 4); // (1, 4) 21
mat_mul(&buf[242] /* (4, 1) */, &buf[0] /* (1, 4) */, &buf[246] /* (4, 4) */, 4, 1, 1, 4, 1, 4, 4, 1); // (4, 4) 24
// sgd for 24
for (uint32_t k=0;k<16;++k){
	buf[5 + k] -= buf[246 + k] * lr;
}
// sgd for 19
for (uint32_t k=0;k<68;++k){
	buf[21 + k] -= buf[170 + k] * lr;
}
float mm1[4] = {0.6919726133346558, 0.8942977786064148, 0.9723480939865112, 1.7384986877441406, };
    printf("============================\nTEST::mm1\n");
    if(check(&buf[89], mm1, 4)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[89], 4);printf("TRUE:\n");print(mm1, 4); }float sigmoid1[4] = {0.6664055585861206, 0.7097762823104858, 0.7255872488021851, 0.8504962921142578, };
    printf("============================\nTEST::sigmoid1\n");
    if(check(&buf[93], sigmoid1, 4)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[93], 4);printf("TRUE:\n");print(sigmoid1, 4); }float mm2[17] = {1.6943031549453735, 1.278731107711792, 1.2415246963500977, 1.759682059288025, 1.3145262002944946, 1.3903298377990723, 1.26283597946167, 1.9423998594284058, 1.6398431062698364, 1.7538594007492065, 1.928623080253601, 1.7280383110046387, 1.6069769859313965, 1.8275859355926514, 1.2193408012390137, 1.9021128416061401, 1.7387797832489014, };
    printf("============================\nTEST::mm2\n");
    if(check(&buf[98], mm2, 17)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[98], 17);printf("TRUE:\n");print(mm2, 17); }float log_softmax[17] = {-2.771366834640503, -3.186938762664795, -3.2241454124450684, -2.7059879302978516, -3.151143789291382, -3.0753402709960938, -3.202834129333496, -2.5232701301574707, -2.82582688331604, -2.71181058883667, -2.5370469093322754, -2.7376317977905273, -2.8586931228637695, -2.6380839347839355, -3.2463293075561523, -2.5635571479797363, -2.7268900871276855, };
    printf("============================\nTEST::log_softmax\n");
    if(check(&buf[115], log_softmax, 17)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[115], 17);printf("TRUE:\n");print(log_softmax, 17); }float nll_loss[1] = {2.5635571479797363, };
    printf("============================\nTEST::nll_loss\n");
    if(check(&buf[132], nll_loss, 1)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[132], 1);printf("TRUE:\n");print(nll_loss, 1); }float nll_loss_grads[1] = {1.0, };
    printf("============================\nTEST::nll_loss_grads\n");
    if(check(&buf[133], nll_loss_grads, 1)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[133], 1);printf("TRUE:\n");print(nll_loss_grads, 1); }float log_softmax_grads[17] = {0.06257641315460205, 0.04129810258746147, 0.03978976979851723, 0.06680428981781006, 0.042803142219781876, 0.04617391526699066, 0.04064684361219406, 0.08019692450761795, 0.05925963446497917, 0.06641644239425659, 0.079099640250206, 0.06472344696521759, 0.05734365060925484, 0.07149813324213028, 0.03891679644584656, -0.9229697585105896, 0.0654224306344986, };
    printf("============================\nTEST::log_softmax_grads\n");
    if(check(&buf[135], log_softmax_grads, 17)){
        printf("\033[32mOK!\033[0m\n");
    } else {
        printf("\033[31mNO OK!\033[0m\n");    
        printf("OUT:\n");print(&buf[135], 17);printf("TRUE:\n");print(log_softmax_grads, 17); }    
        return 0;
    }
    
